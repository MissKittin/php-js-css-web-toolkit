# The Herring
Doktor Sledzik i mister Zgredzik  
Device for tracking users

## Required PHP extensions
* `PDO`
* `pdo_pgsql` or `pdo_mysql` or `pdo_sqlite`

## Required libraries
* `measure_exec_time.php`
* `rand_str.php`
* `sortTable.js`
* `has_php_close_tag.php` (for tests)
* `include_into_namespace.php` (for tests)

## Supported databases
* PostgreSQL
* MySQL
* SQLite3

## Methods
* `add()`  
	add a record to the database
* `move_to_archive(int_days)` [returns `int_affected_rows`]  
	move records older than `int_days` to the archive
* `flush_archive()`  
	delete all records from the archive
* `dump_archive_to_csv(string_output_file=null)` [returns `string_content`|`null`]  
	if `output_file === null` returns the result
* `generate_report(string_output_file=null)` [returns `string_content`|`null`]  
	if `output_file === null` returns the result
* `generate_report_short(string_output_file=null)` [returns `string_content`|`null`]  
	if `output_file === null` returns the result
* **[static]** `generate_report_from_csv(string_input_file, string_output_file=null)` [returns `string_content`|`null`]  
	generates a report from the data generated by the `dump_archive_to_csv` method  
	**warning:**  
	`pdo_sqlite` extension is required  
	data from the csv file is loaded into the SQLite3 database in `:memory:`, you have been warned
* **[static]** `generate_report_short_from_csv(string_input_file, string_output_file=null)` [returns `string_content`|`null`]  
	generates a report from the data generated by the `dump_archive_to_csv` method  
	**warning:**  
	`pdo_sqlite` extension is required  
	data from the csv file is loaded into the SQLite3 database in `:memory:`, you have been warned

## Constructor parameters
* `pdo_handle` [object]  
	required
* `table_name_prefix` [string]  
	default: `herring_`
* `create_table` [bool]  
	send table creation query  
	default (safe): `true`
* `timestamp` [int]  
	force timestamp
* `ip` [string]  
	force visitor IP  
	default: `$_SERVER['REMOTE_ADDR']`  
	**note:** throws an `herring_exception` if the parameter and default value are not defined
* `user_agent` [string]  
	force User-Agent  
	default: `$_SERVER['HTTP_USER_AGENT']`
* `cookie_name` [string]  
	set tracking cookie name  
	not defining means disabling this functionality (eg. for crawlers)  
	**note:** set this and do not set `cookie_value` to generate string
* `cookie_value` [string]  
	force tracking cookie value  
	**note:** `cookie_name` must be defined
* `referer` [string]  
	force Referer value  
	default: `$_SERVER['HTTP_REFERER']`
* `uri` [string]  
	force request URI  
	default: `$_SERVER['REQUEST_URI']`  
	**note:** throws an `herring_exception` if the parameter and default value are not defined
* `uri_without_get` [bool]  
	remove get parameters from URI  
	default: `true`
* `maintenance_mode` [bool]  
	set to true if you want to generate reports  
	default: `false`
* `setcookie_callback` [callable]  
	define custom setcookie function  
	arguments: `$cookie_name, $cookie_value`

## Table layout
* {TABLENAMEPREFIX}visitors  
	* PostgreSQL  
		`id` SERIAL PRIMARY KEY  
		`timestamp` INTEGER  
		`ip` VARCHAR(39)  
		`user_agent` TEXT  
		`cookie_id` VARCHAR(40)  
		`referer` VARCHAR(2083)  
		`uri` TEXT
	* MySQL  
		`id` INTEGER NOT NULL AUTO_INCREMENT [PRIMARY KEY]  
		`timestamp` INTEGER  
		`ip` VARCHAR(39)  
		`user_agent` TEXT  
		`cookie_id` VARCHAR(40)  
		`referer` VARCHAR(2083)  
		`uri` TEXT
	* SQLite3  
		`id` INTEGER PRIMARY KEY AUTOINCREMENT  
		`timestamp` INTEGER  
		`ip` VARCHAR(39)  
		`user_agent` TEXT  
		`cookie_id` VARCHAR(40)  
		`referer` VARCHAR(2083)  
		`uri` TEXT
* {TABLENAMEPREFIX}archive
	* PostgreSQL  
		`id` SERIAL PRIMARY KEY  
		`timestamp` INTEGER  
		`date` VARCHAR(10)  
		`ip` VARCHAR(39)  
		`user_agent` TEXT  
		`cookie_id` VARCHAR(40)  
		`referer` VARCHAR(2083)  
		`uri` TEXT
	* MySQL  
		`id` INTEGER NOT NULL AUTO_INCREMENT [PRIMARY KEY]  
		`timestamp` INTEGER  
		`date` VARCHAR(10)  
		`ip` VARCHAR(39)  
		`user_agent` TEXT  
		`cookie_id` VARCHAR(40)  
		`referer` VARCHAR(2083)  
		`uri` TEXT
	* SQLite3  
		`id` INTEGER PRIMARY KEY AUTOINCREMENT  
		`timestamp` INTEGER  
		`date` VARCHAR(10)  
		`ip` VARCHAR(39)  
		`user_agent` TEXT  
		`cookie_id` VARCHAR(40)  
		`referer` VARCHAR(2083)  
		`uri` TEXT

## How it works
Herring works on two tables: visitors and archive  
The latest logs are loaded into the visitors table  
The archive table contains entries older than n days, processed and ready for dump or report generation  
Generating the report may take a while, so it is recommended to generate it outside the main application

## Note
Throws an `herring_exception` when there is a database connection error or query execution error  
May throw `PDOException` depending on `PDO::ATTR_ERRMODE`  
The tracking cookie is valid for 2 years, unless a setcookie callback is defined  
You have to write the report generating tool/interface/cron job yourself

## Hint
Calling `move_to_archive(0)` will move all records to the archive  
You can add new records directly in the application or through a queue worker  
You can use cron for database maintenance and report generation

## Usage
Adding a record to the database:
```
require './com/herring/main.php';

try {
	(new herring([
		'pdo_handle'=>new PDO('sqlite:./var/databases/herring.sqlite3'),
		'cookie_name'=>'herring_id'
	]))->add();
} catch(herring_exception $error) {
	echo 'Error: '.$error->getMessage();
	exit();
}
```

Exporting data and generating a report:
```
require './com/herring/main.php';

try {
	$herring=new herring([
		'pdo_handle'=>new PDO('sqlite:./var/databases/herring.sqlite3'),
		'maintenance_mode'=>true
	]);

	$herring->move_to_archive(0); // move all records

	$herring->generate_report('./var/log/herring_report_'.date('Y-m-d_H-i-s').'.html');
	// the report can be very large
	// if you don't need detailed information,
	// use the generate_report_short method

	$herring->dump_archive_to_csv('./var/log/herring_data_'.date('Y-m-d_H-i-s').'.csv'');

	$herring->flush_archive();
} catch(herring_exception $error) {
	echo 'Error: '.$error->getMessage().PHP_EOL;
	exit(1);
}
```

## Crawlers
Herring does not distinguish between a bot and man  
For this purpose, you can use, for example, `preg_match` or composer package:
```
function is_crawler()
{
	// Source: https://wtools.io/php-snippet/check-if-user-agent-is-bot-in-php

	if(
		isset($_SERVER['HTTP_USER_AGENT']) &&
		preg_match(
			'/abacho|accona|AddThis|AdsBot|ahoy|AhrefsBot|AISearchBot|alexa|altavista|anthill|appie|applebot|arale|araneo|AraybOt|ariadne|arks|aspseek|ATN_Worldwide|Atomz|baiduspider|baidu|bbot|bingbot|bing|Bjaaland|BlackWidow|BotLink|bot|boxseabot|bspider|calif|CCBot|ChinaClaw|christcrawler|CMC\/0\.01|combine|confuzzledbot|contaxe|CoolBot|cosmos|crawler|crawlpaper|crawl|curl|cusco|cyberspyder|cydralspider|dataprovider|digger|DIIbot|DotBot|downloadexpress|DragonBot|DuckDuckBot|dwcp|EasouSpider|ebiness|ecollector|elfinbot|esculapio|ESI|esther|eStyle|Ezooms|facebookexternalhit|facebook|facebot|fastcrawler|FatBot|FDSE|FELIX IDE|fetch|fido|find|Firefly|fouineur|Freecrawl|froogle|gammaSpider|gazz|gcreep|geona|Getterrobo-Plus|get|girafabot|golem|googlebot|\-google|grabber|GrabNet|griffon|Gromit|gulliver|gulper|hambot|havIndex|hotwired|htdig|HTTrack|ia_archiver|iajabot|IDBot|Informant|InfoSeek|InfoSpiders|INGRID\/0\.1|inktomi|inspectorwww|Internet Cruiser Robot|irobot|Iron33|JBot|jcrawler|Jeeves|jobo|KDD\-Explorer|KIT\-Fireball|ko_yappo_robot|label\-grabber|larbin|legs|libwww-perl|linkedin|Linkidator|linkwalker|Lockon|logo_gif_crawler|Lycos|m2e|majesticsEO|marvin|mattie|mediafox|mediapartners|MerzScope|MindCrawler|MJ12bot|mod_pagespeed|moget|Motor|msnbot|muncher|muninn|MuscatFerret|MwdSearch|NationalDirectory|naverbot|NEC\-MeshExplorer|NetcraftSurveyAgent|NetScoop|NetSeer|newscan\-online|nil|none|Nutch|ObjectsSearch|Occam|openstat.ru\/Bot|packrat|pageboy|ParaSite|patric|pegasus|perlcrawler|phpdig|piltdownman|Pimptrain|pingdom|pinterest|pjspider|PlumtreeWebAccessor|PortalBSpider|psbot|rambler|Raven|RHCS|RixBot|roadrunner|Robbie|robi|RoboCrawl|robofox|Scooter|Scrubby|Search\-AU|searchprocess|search|SemrushBot|Senrigan|seznambot|Shagseeker|sharp\-info\-agent|sift|SimBot|Site Valet|SiteSucker|skymob|SLCrawler\/2\.0|slurp|snooper|solbot|speedy|spider_monkey|SpiderBot\/1\.0|spiderline|spider|suke|tach_bw|TechBOT|TechnoratiSnoop|templeton|teoma|titin|topiclink|twitterbot|twitter|UdmSearch|Ukonline|UnwindFetchor|URL_Spider_SQL|urlck|urlresolver|Valkyrie libwww\-perl|verticrawl|Victoria|void\-bot|Voyager|VWbot_K|wapspider|WebBandit\/1\.0|webcatcher|WebCopier|WebFindBot|WebLeacher|WebMechanic|WebMoose|webquest|webreaper|webspider|webs|WebWalker|WebZip|wget|whowhere|winona|wlm|WOLP|woriobot|WWWC|XGET|xing|yahoo|YandexBot|YandexMobileBot|yandex|yeti|Zeus/i',
			$_SERVER['HTTP_USER_AGENT']
		)
	)
		return true;

	return false;
}

require './com/herring/main.php';

try {
	if(!is_crawler())
		(new herring([
			'pdo_handle'=>new PDO('sqlite:./var/databases/herring.sqlite3'),
			'cookie_name'=>'herring_id'
		]))->add();
	else
	{
		// you can log the request or remove this block

		(new herring([
			'pdo_handle'=>new PDO('sqlite:./var/databases/herring.sqlite3'),
			'table_name_prefix'=>'herring_crawlers_'
		]))->add();
	}
} catch(herring_exception $error) {
	echo 'Error: '.$error->getMessage();
	exit();
}
```

## Testing
The test can be performed in two ways: short (the default, with a small amount of data) and long (with a large amount of data)  
To run long mode, run the test with the `long` parameter

## Portability
Create a `./lib` directory  
and copy the required libraries to this directory.  
Libraries in this directory have priority over `../../lib`.
